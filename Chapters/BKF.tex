\chapter{Intent Change Estimation Based on Physical Interactions of an	Exoskeleton User}\label{chapter:BKF}
The IMM estimation framework presented previously is reactive as it monitors signs of gait transition i.e.~if the CoM trajectory after gait transition does not resemble library gaits, the IMM algorithm will misidentify the intended change until after it has been realized. However, anticipative intent inference is more desirable to time the assistance delivery appropriately and help the user realize their intended gait transition. Improper assistance timing may result in the robot resisting the user's actions, hampering HRI fluency. Intent may be anticipatively inferred by identifying the actions the user takes to realize their intent change and using data from gait features to detect them. Actions indicative of intent change may be detected by monitoring the interactions the user has with the exoskeleton and the environment. These interactions may provide an earlier indicator of intent changes compared to CoM or joint motions making it possible to anticipate user intent and provide assistance to the user to help realize the desired objective. 

\section{Quantifying intent - Enabling estimation}
User intent is an abstract notion, so it must be quantified and inferred using a measurable quantity, and this quantification is a design choice. The intended gait speed was chosen to represent user intent as the primary objective of the exoskeletons herein is gait rehabilitation. Estimating the gait speed of an individual may increase the possibility for finer control of the gait and also limit the need to train for multiple discrete scenarios. The state of the exoskeleton user is represented in a vector \[\x = [\mathbf{p}_{CoM}^{\top} ,\mathbf{v}_{CoM}^{\top}]^{\top} \] 
To capture intent, the state was extended to include the intended gait velocity $ z $ as a hidden state in an augmented state vector $ \q = [\x^{\top} ,z]^{\top} $. The gait velocity $ z $ only represents the velocity in the sagittal plane. Velocity in the transverse \footnote{The transverse plane is the plane that divides the body into top and bottom parts. } plane (e.g., while turning) is neglected, as the exoskeleton restricts adduction/abduction of the legs. This state augmentation approach allows using the Kalman filter to directly estimate the intended gait speed. 

Previously performed studies of bipedal locomotion give us an idea of how changes in walking gaits correspond to transitions in user intent. These physical indicators include differences in CoM trajectories and foot placement, as illustrated in Fig.~\ref{fig:main_idea}. Ground contacts greatly influence the stability of legged locomotion, so it was hypothesized that intent will be reflected strongly in the user's choice of ground contacts through foot placement \cite{bhounsule2014foot}. Modulating foot placement while walking is an effective control mechanism to maintain stability \cite{hof2010balance,bhounsule2015control}, and it has been shown that velocity changes at MS influence foot placement at TD \cite{wang2014stepping,redfern1994model}. 

\begin{figure}
	\centering
	\includegraphics[width=0.5\linewidth]{main_idea_bkf}
	\caption{Change in intended velocity may be inferred from change in step length}\label{fig:main_idea}
\end{figure}

The B-SLIP model may be used to adequately model steady-state walking, and foot placement was found to be critical in optimizing periodic gaits. The model does not inherently capture the active changes required to change speed nor the first-principles humans employ for foot-placement as a function of the desired gait speed. These aspects were initially modeled by designing a controller for the B-SLIP model to emulate human motor control. With such a design, intent changes may be considered analogous to controller setpoint changes. Several theories try to explain human motor control, one of which says that the human sensorimotor system relies on optimal control \cite{todorov2004optimality,sylla2014assessing}. Therefore, we chose to assume the human motor controller to be a Linear Quadratic Regulator (LQR). The MS-to-MS Poincar\'e map was linearized about a periodic gait and the linearized model was used to design a controller that minimized deviations from a specified gait. 

The dynamics of the B-SLIP model are nonlinear and linearizing them about a single periodic gait results in a model valid for a very small portion of the gait which rendered the controller unable to handle large speed changes. A derivative-free technique i.e., the Unscented Transform \cite{manchester2016derivative} was employed to generate a linear model. This technique required integrating dynamics backward in time which was difficult to do for the hybrid dynamics of the B-SLIP model as the gait event timing cannot be fixed. Therefore, due to the lack of first principles that describe human choices to bring about intended gait changes, a data-driven approach was chosen to model the relationship between intended gait speed and foot placement.

\begin{figure}
	\centering
	\includegraphics[width=0.35\linewidth]{step_change.pdf}
	\caption{Speed-up and slow-own increase and decrease the step length respectively}\label{fig:step_change}
\end{figure}

There is a correlation between step length and walking velocity that can be exploited to infer changes in intended gait speed. People walking unassisted at lower velocities exhibit shorter step lengths, and an increase in velocity results in an increase in step length \cite{kuo2001simple,andriacchi1977walking}, as illustrated in Fig.~\ref{fig:step_change}. Such a velocity-step-length relationship can also be viewed as valid assuming that the walk ratio is roughly constant \cite{sekiya1997optimal}. 

The walk ratio, defined as the ratio of the step length to cadence~\cite{rota2011walk}, is fairly invariant with respect to gait speeds for community ambulation, i.e.,~gait velocities greater than 0.8 m/s, despite age and terrain. It is affected when attention is divided between motor and cognitive tasks i.e., dual-task walking \cite{bogen2018walk}. The walk ratio increases as speed decreases below community ambulation velocities \cite{murakami2017estimated} and is dependent on the nature and severity of injuries \cite{rota2011walk} during unassisted walking. In rehabilitation, the variability in the walk ratio may be reduced due to the stability provided by the exoskeleton structure and consistent timing of the exoskeleton assistance \cite{seo2015new}. While the effects of exoskeleton-assisted walking on the walk ratio remain open, this analysis suggests that it is reasonable to assume a constant walk ratio for the work herein.

\section{Framework to estimate desired gait speed}

It was assumed that intent changes made at the first MS are reflected in the placement of the foot at TD and then maintained as constant until the subsequent MS. As illustrated in Fig.~\ref{fig:step_stages}, a step starts at MS, the footstep is finalized at TD, and the step is completed at the next MS. Therefore, a twice-per-step strategy that relies on a simple model to exploit the relationship between velocity change and step length change was used to estimate intent at TD and MS. 

\subsection{Buttressed Kalman Filter}
\begin{figure}
	\centering
	\includegraphics[width=0.9\linewidth]{step_stages.pdf}
	\caption{Two-stage estimation process}\label{fig:step_stages}
\end{figure}

A staged estimation scheme, as illustrated in Fig.~\ref{fig:block_diag}, was considered to infer intent changes using step length change information. The unit delay represents the passing of estimates as initial conditions for the next estimation cycle. In this scheme, footstep information at TD was first used to update the intent state for the initial MS. The position and velocity of the CoM were then corrected with a second update at the terminal MS of the step. A simple data-driven model of step length was used as a function of the velocity $ v_x $ at the MS prior to TD, desired velocity $ z $, and leg length $ l_{leg} $:

\begin{equation}
	l_{step} = [v_x\ (z-v_x)\ l_{leg}] \greekvec{\kappa} \label{eq:stepModel},
\end{equation}
where $ \greekvec{\kappa} $ is a vector containing regression coefficients and the model output is a scalar value in meters. This model takes into consideration the nominal step length as a function of leg length, the current velocity, and desired velocity.

\begin{figure}
	\centering
	\begin{overpic}[width=0.8\linewidth,percent]{block_diagram}
		\put(13,11){ \eqref{eq:sig_yy} - \eqref{eq:tdCovUp}}
		\put(48,11){\eqref{eq:model} - \eqref{eq:P_up}}
	\end{overpic}
%	\includegraphics[width=0.7\linewidth]{block_diagram.pdf}
	\caption{Twice-per-step strategy to estimate user intent}\label{fig:block_diag}
\end{figure}

The step length model may be used as a measurement model in a Kalman filter framework to relate the intended gait speed to the measured step length. The estimator operates on the state $ \hat{\q} $ and its covariance $ \P $. In the following equations, the superscripts $ - $ and $ + $ denote pre-/post-update states respectively, the subscripts $ M $ and $ T $ denote MS and TD respectively, and the bar denotes the update location. For instance, $\hat{\q}_{M|T}^+ $ represents the state of the CoM at MS updated at TD. 

Since the footstep model is data-driven and may have inaccuracies, a process noise covariance $ \Q_{T} $ was added to the state estimate covariance $ \P^-_{M|M} $. Additionally, the estimated measurement covariance $ \Ssigma_{yy} $ was computed using the Jacobian of the measurement model $ \H_{T} $ and measurement covariance $ \R_{T} $. The predicted step length from \eqref{eq:stepModel} was compared to the measured step length $ \tilde{\y}_{T} $. The state at MS $ \hat{\q}_{M|M}^- $ and its covariance were then updated using a Bayesian update as shown in \eqref{eq:tdUp} and \eqref{eq:tdCovUp}.

\begin{eqnarray}
	\hat{\y}_{T} &=&  l_{step}(\hat{v}_x,\hat{z}, l_{leg}) \nonumber \\
	\H_{T} &=& \left. \frac{\partial \hat{\y}_{T}}{\partial \q}\right|_{\hat{\q}} \nonumber \\
	\Ssigma_{yy} &=& \H_{T} \left(\P^-_{M|M} + \Q_{T}\right) \H_{T}^{\top} + \R_{T} \label{eq:sig_yy}\\
	\hat{\q}_{M|T}^+ &=& \hat{\q}_{M|M}^- + \P^- \H_{T}^{\top} \Ssigma_{yy}^{-1} (\tilde{\y}_{T} - \hat{\y}_{T})  \label{eq:tdUp}\\
	\P^+_{M|T} &=& \P^-_{M|M} -\P^-_{M|M} \H_{T}^{\top} \Ssigma_{yy}^{-1} \H_{T} \P^-_{M|M} \label{eq:tdCovUp}
\end{eqnarray}

This update to the previous MS state using TD information then primes $ \hat{\q}_{M|T}^+ $ and $ \P^+_{M|T} $ to be used with a Kalman filter.	Simple dynamics are used to propagate this state and covariance to the next MS 
\begin{eqnarray}
			\hat{\q}_{M|T}^+ &\leftarrow& \D \hat{\q}_{M|T}^+ \label{eq:model}\\
			\P^+_{M|T} &\leftarrow& \D  \P^+_{M|T} \D^{\top} + \Q_{M} \label{eq:cov}
\end{eqnarray}

These simple dynamics change the signs of the lateral position and velocity of the CoM to emulate the switching of the stance foot and allow for the application of a standard Kalman filter from MS to MS. It is assumed that the motion of the CoM is periodic with respect to the stance foot; however, since the CoM position is referenced from the stance foot, which changes step to step, the lateral position and velocity also change signs. Therefore, the propagation matrix is $ \D = {\rm diag}([1 ,-1 ,1 ,1 ,-1 ,1 ,1]) $. 

The second update takes place at the next MS, with the stance foot switched. The outputs of \eqref{eq:model} and \eqref{eq:cov} are updated using a Kalman update 
\begin{eqnarray}
	\K &=& \P^+_{M|T} \H_{M}^{\top} \left(\H_{M} \P^+_{M|T} \H_{M}^{\top} + \R_{M}\right)^{-1}\\
	\hat{\q}_{M|M}^+ &=& \hat{\q}_{M|T}^+ + \K(\tilde{\y}_{M} - \H_{M} \hat{\q}_{M|T}^+) \\
	\P^+_{M|M} &=& (\I - \K \H_{M}) \P^+_{M|T} \label{eq:P_up}
\end{eqnarray}
where the measurement model Jacobian is $ \H_{M} = \I^{6\times7} $ since the measurements are $ \tilde{\y}_{M} = [\tilde{\p}_{CoM} ,\tilde{\v}_{CoM}]^{\top} $.

This approach varies from a conventional Kalman filter formulation as the information obtained at TD is used to update the prior distribution for the MS-to-MS estimator. As the dynamics-free Bayesian update reinforces the MS-to-MS Kalman filter, this estimation setup has been termed as a Buttressed Kalman Filter.

The estimator needs to send an output signal to the exoskeleton to inform its controller of changes in the user's intent. Since the representation of user intent was chosen to be the forward velocity, the change of $ \hat{z} $ from MS to MS represents the user's desire to change gait speed. The estimator uses a simple model to predict the step length, so it does not emulate the exact relationship between the velocity at MS and the ensuing step length. As a result, using the estimated value of the intended velocity is not a good indicator of intent, as this value may not match the measured values. However, the change of the intended velocity from MS to MS $ \Delta z $ is a better candidate for intent change indication. This quantity represents the expected ``acceleration" from MS to MS so it can be considered to be a ``speed-up" signal when the rate is positive or a ``slow-down" signal when the rate is negative. Inferring intent as a ``speed-up" or ``slow-down" signal is consistent with the fundamentally abstract nature of intent as opposed to the concrete velocity value given by the estimator. This ability to capture continuous adjustments may result in finer control of the exoskeleton compared to discrete activity classification that is more commonly used.

\subsection{Simple model to relate intended velocity and foot placement}

The two main gait events to be identified for the estimator were MS and TD. For healthy individuals walking independently, the foot touchdown process starts with a heel strike, the ankle then undergoes plantarflexion and the foot then rests flat on the ground. Plantarflexion is the motion of the foot about the ankle when it rotates away from the shank, and since the exoskeleton has no ankle mobility, the subject has to touch down with a nearly flat foot. This results in step lengths that are shorter than those observed in independent walking. Additionally, the subject walking in the exoskeleton used an ambulatory device such as a walker or crutches. Consequently, data from walking trials of subjects using the Ekso GT \cite{exoWalkerData} was used in the regression for the step length model shown in \eqref{eq:stepModel}. To perform the regression, the velocity at the subsequent MS was assumed to be the desired velocity. For example, suppose $ v_k $ was the forward velocity of the user at MS at time $ k $. The regression was set up such that $ l_{step,{k+1}} = [v_{k}\ (v_{k+1}-v_{k})\ l_{leg}] \greekvec{\kappa} $, where the subscript $ x $ has been omitted for conciseness, and the desired velocity was $ v^d = v_{k+1} $. This formulation provided insight into the step length, using future velocity data to provide a proxy for the intended velocity.

\section{Results with walking trial data}

\subsection{Subject without iSCI}

The trial shown in this section was that of a subject without iSCI walking in free mode. In this mode, the exoskeleton provides constant assistance akin to gravity compensation to the user. The measurement used at TD was the step length, so the measurement vector was $ \tilde{\y}_{T} = [l_{step}] $. Measurements of all positions and velocities were available at MS so $ \tilde{\y}_{M} = [\p_{CoM} ,\v_{CoM}]^{\top} $. The process noise covariance $ \Q $ and the measurement noise covariance $ \R $ were given by
\begin{eqnarray}
	\Q_M &=& {\rm diag}([1 ,1 ,1 ,1 ,1 ,1 ,10]) \times 10^{-4} \\
	\R_M &=& {\rm diag}([10^{4} ,10^{4} ,10^{4} ,10^{5} ,1 ,1]) \times 10^{-10} \\ % x y z vx vy vz at MS 
	\Q_T &=& 10^{-4} \\
	\R_T &=& 10^{-5} % xf at TD
\end{eqnarray}
where process noise covariances for positions and velocities are reported with units m\textsuperscript{2} and m\textsuperscript{2}/s\textsuperscript{2} respectively.

\begin{figure}
	\centering
	\includegraphics[width=0.7\linewidth]{ab_regress.eps}
	\caption{Performance of the regressed model, \eqref{eq:stepModel}, for the uninjured subject for a speed-up trial} \label{fig:ab_regressor}
\end{figure}

\begin{figure}
	\centering
	\includegraphics[width=0.7\linewidth]{ab_results.eps}
	\caption{Estimator performance for SU and SD trials for an uninjured subject} \label{fig:ab_results}
\end{figure}

The regression coefficients for the footstep model were $ \greekmat{\kappa} = [0.3325 ,0.2635 ,0.3757]^{\top} $ for this subject. The step lengths for an SU trial are shown in Fig.~\ref{fig:ab_regressor}. The regressed model was able to estimate the footstep to within $ \sim $ 5cm with an RMS error of 2.5cm. Consequently, it will be observed that footstep changes alone provided sufficient information to estimate intent changes in this case. The data in Fig.~\ref{fig:ab_results} illustrates the estimator performance for this trial. The stem plot represents the intent of the user as inferred at TD; a positive value indicates speed-up and a negative value indicates slow-down anticipated for the subsequent MS. The vertical line represents the MS closest to the time the speed-change command was issued and a significant speed change is to be expected after this step. The estimator accurately estimated the speed change for the trials i.e., the value of the signal in the stem plot should be positive for speed-up and negative for slow-down after the command is issued.

The estimator performance for all trials of this subject is aggregated in Table.~\ref{table:ab_results_ag}. The ``Command Step" column refers to the MS when the command was issued and the ``Detection Step" refers to the step during which TD the intent change was detected. Since the user must first process the command given, an intent detection delay of up to one step was deemed permissible. All SU and SD trials fit this criterion. 
		
For further analysis, the estimated change in $ z $ for every step was compared to the measured change. If the speed change sign was correctly anticipated, it was considered a successful trial. The probability of successful intent change inference for the aggregated trials of the uninjured subject was 69\% with a 95\% confidence interval \cite{brown2001interval} of 59\% - 78\%. The estimator has difficulty estimating intent changes when the velocity change is low, i.e., less than $ \sim $ 0.15 m/s due to insufficient changes in step lengths. This may be the reason for a majority of the erroneous estimates.
%
\input{Chapters/table_ab.tex}%
%

\subsection{Subject with iSCI}

The following evaluation uses data from trials of IU-2 (Sec.~\ref{sec:exoData}) who had previously experienced an incomplete SCI from the middle to the lower spine (T8 to L2). Individuals with these injuries generally exhibit good upper-body movement, control, and balance, but signals to the hips and legs are affected \cite{reevespinal}. % Had to cite Superman
For use with such an injury, the exoskeleton was set to adaptive mode. In this mode, the exoskeleton joints follow predefined trajectories and correct any deviations from them. Consequently, intent change is perceived as a deviation from the preset trajectories, and therefore the exoskeleton attempts to correct the user's gait. 

The nature of the assistance provided in adaptive mode results in a difference in the goals of the user and the robot after the intent change. As a result, the step lengths did not exhibit significant enough variation or a consistent trend to allow for intent inference by themselves. The lack of step length variation is further supported by the regression coefficients for this subject $ \greekmat{\kappa} = [0.0818	,0.0551	,0.4045]^{\top} $. When compared to the regression coefficients for the model for the uninjured user, the iSCI model regression coefficients for $ v_k $ and $ (z-v_x)$ are smaller by an order of magnitude. This difference in coefficient magnitude shows there was not enough correlation between velocity changes and step length.

\begin{figure}[tb]
	\centering
	\includegraphics[width=0.7\linewidth]{nab_regress.eps}
	\caption{Performance of the regressed models, Eqs.~\eqref{eq:stepModel} and \eqref{eq:currentModel}, for a subject with iSCI} \label{fig:nab_regressor}
\end{figure}
%

Figure~\ref{fig:nab_regressor} shows the step lengths for an SU trial; the estimated step lengths do not follow measurements, and only vary by $ \sim $2 cm throughout the trial, whereas the measurements vary by $ \sim $7 cm. Therefore, it was not possible to rely solely on footstep data.  Thus, the RMS current of the hip motor during the swing phase was added to the measurements obtained at TD, so that $ \tilde{\y}_{T} = [l_{step} ,I_{RMS}]^{\top} $. Another regression was performed to establish a relationship between the intended velocities and swing current:
\begin{equation}
	I_{RMS} = [v_x\ (z-v_x)] \greekvec{\alpha} \label{eq:currentModel},
\end{equation}
where $ \greekvec{\alpha} $ is a vector of the regression coefficients, found as $ \greekvec{\alpha} = [8.6067 ,4.2420]^{\top} $ for this trial.

The process noise covariance $ \Q $  and the measurement noise covariance $ \R $ were then selected as follows.
\begin{eqnarray}
	\Q_M &=& {\rm diag}([1 ,1 ,1 ,1 ,1 ,1 ,10]) \times 10^{-4} \\
	\R_M &=& {\rm diag}([10^{4} ,10^{4} ,10^{4} ,10^{5} ,1 ,1]) \times 10^{-10} \\ % x y z vx vy vz at MS 
	\Q_T &=& 10^{-3}\\
	\R_T &=& {\rm diag}([1 ,1]) \times 10^{-4} % xf at TD
\end{eqnarray}
where noise covariances for positions, velocities, and currents are reported with units m\textsuperscript{2}, m\textsuperscript{2}/s\textsuperscript{2}, and A\textsuperscript{2} respectively.

\begin{figure}
	\centering
	\includegraphics[width=0.75\linewidth]{curr_v_footsteps.eps}
	\caption{Estimator performance comparison before and after including hip current measurements} \label{fig:c_v_f}
\end{figure}

The hip current, in addition to the footstep data, provided sufficient information to be able to infer the user's intent immediately after the speed-change command was issued.
The performance of estimator for one of the SU trials with and without hip current measurements is illustrated in Fig.~\ref{fig:c_v_f}. When relying solely on step length measurements, the estimator was unable to output accurate speed-up/slow-down signals in the beginning of the trial, and the change in intent to speed up was detected a step after the command was issued. There was a small dip of 0.05 m/s in velocity after the speed up command was issued and this may be because the exoskeleton assistance in adaptive mode overpowered the user's motion in order to maintain the nominal joint trajectory. However, with the inclusion of hip motor currents, the estimator was able to correctly identify the change in intent to speed up during the same step the command was issued and before the user began physically speeding up. This anticipative performance of the estimator is shown in Fig.~\ref{fig:nab_results} for additional SU and SD trials. 

The estimated value of $ \hat{z} $ for one SU trial was compared to the measured forward velocity over the trial, as illustrated in Fig.~\ref{fig:m_v_e}. The vertical solid lines denote MS, dashed lines denote TD, and red stars denote the value of $ \hat{z} $, i.e., the estimate of the user's intended velocity. Since $\hat{v}^x_d$ represents the desired speed of the user, its value at TD was compared to the measured velocity at the subsequent MS, by which point the intended velocity should be realized. The values of $ \hat{z} $ predicted at TD show strong correlation with the measured values of $v_x$ at the next MS, but are not exact. For the trial illustrated in Fig.~\ref{fig:m_v_e}, the correlation coefficient of $ \hat{z} $ at TD to the measured $ v_x $ at the next MS was 0.63. By comparison, the correlation coefficient of $ \hat{v}_x $ at TD to the measured $ v_x $ at the next MS was -0.11. This correlation further bolsters the hypothesis that incorporating information at touchdown in the estimator is valuable for anticipating speed changes.

\begin{figure}
	\centering
	\includegraphics[width=0.7\linewidth]{nab_results.eps}
	\caption{Estimator performance for SU and SD trials for a subject with iSCI} \label{fig:nab_results}
\end{figure}

\begin{figure}
	\centering
	\includegraphics[width=0.7\linewidth]{estimated_vs_measured.eps}
	\caption{Estimated desired velocity at MS as predicted at TD ($\hat{z}$) compared to velocity $v_x$ over the stride.} \label{fig:m_v_e}
\end{figure}
%
\input{Chapters/table_nab.tex}
%
The estimator performance for all trials of this subject is aggregated in Table~\ref{table:nab_results_ag} with similar pass/fail criteria as the trials with the uninjured subject. For trial SD-03, the estimator detected the speed change after the command but there were estimator inaccuracies for the subsequent step. There were fluctuations of $ \sim $0.15 m/s in the forward velocity of the user after the command was issued. This may be due to the high gait variability due to spastic disturbances that are common in individuals with SCIs \cite{malhotra2009spasticity}. It has been observed that it is more difficult to detect speed-up intent changes in injured individuals since the intent signal is considerably diminished compared to slow-down trials \cite{gambon2020effects} due to the user's reduced strength.

The aggregate probability of success for walking trials of the subject with iSCIs was 78\% with a 95\% confidence interval of 68\% to 86\%. All trials except SD-03 had individual percentages of success of at least 70\%. Trial SU-02 had a probability of success of 92\% and SU-01 and SD-01 had a 100\% success rate. It is worth noting that the trials with high success rates were performed when the subject was rested and SD-03 was the last of multiple back-to-back trials. The subject's exhaustion may have diminished their ability to resist the exoskeleton's inputs and therefore, made intent estimation difficult.

The estimator uses simple dynamics that do not use knowledge of legged locomotion. These simple dynamics along with the limited data to generate the footstep model result in the framework only being able to identify whether the user wants to speed up or slow down and not the target velocity the user wishes to reach. This behavior may be remedied with strategies that establish a more precise relationship between intended gait velocity and foot placement or motor currents.

\section{Exploring the effects of increasing model complexity and the number of considered gait features on estimator accuracy}

Two possible strategies were considered to increase estimator accuracy in detecting SU/SD changes and predicting the magnitude of the desired velocity. One strategy is to increase the number of gait features considered at touch down. The other is to replace the simple linear models with more complex models such as polynomial models or Gaussian Process Regression (GPR) models.

In general, estimator configurations with two measurements showed improvements in performance over its counterpart with one measurement as evidenced from the probabilities of success listed in Tables~\ref{table:su} and \ref{table:sd}. There was no clear superior configuration as the estimator with the linear model and two measurements performed best for SD trials in terms of both, probability of success and RMS prediction error while the GPR model performed best for SU trials. For both SU and SD trials combined, the linear model with two measurements has a success rate of 72\% and an RMS error of 0.15 m/s whereas the GPR model has a success rate of 70\% with an RMS error of 0.12 m/s. It is important to note that these are aggregate results and while comparing individual trials, configurations with one measurement showed a higher probability of success and RMS prediction error for some trials. The estimator configurations listed in Table \ref{table:su} and \ref{table:sd} are detailed as follows.

\begin{table} %SU
	\centering
	\caption{Estimator performance of all configurations for only SU trials} \label{table:su}
	\small
	\begin{tabular}{|c|c|c|c|}
		\hline
		Model & No. of meas. & Probability of success (\%) & RMS error (m/s)\\
		\hline
		Linear & 1 & 79 & 0.15 \\
		\hline
		Linear & 2 & 82 & 0.12 \\
		\hline
		Polynomial & 1 & 61 & 0.14 \\
		\hline
		Polynomial & 2 & 76 & 0.12 \\
		\hline
		GPR & 1 & 47 & 0.15 \\
		\hline
		GPR & 2 & 51 & 0.15 \\
		\hline
	\end{tabular}
\end{table}

\begin{table} %SD
	\centering
	\caption{Estimator performance of all configurations for only SD trials} \label{table:sd}
	\small
	\begin{tabular}{|c|c|c|c|}
		\hline
		Model & No. of meas. & Probability of success (\%) & RMS error (m/s)\\
		\hline
		Linear & 1 & 61 & 0.13 \\
		\hline
		Linear & 2 & 63 & 0.16 \\
		\hline
		Polynomial & 1 & 61 & 0.09 \\
		\hline
		Polynomial & 2 & 53 & 0.18 \\
		\hline
		GPR & 1 & 79 & 0.09 \\
		\hline
		GPR & 2 & 79 & 0.08 \\
		\hline
	\end{tabular}
\end{table}

\subsection{Increasing the number of measurements at touchdown}
Estimator configuration and the considered measurements have a significant impact on estimator performance. The configurations of the BKF presented in previously were able to anticipate changes in gait speed before they were realized. However, the estimator was not able to precisely estimate the magnitude of the anticipated velocity change. The estimator was configured to rely on only the step length for the trials with an uninjured user and root mean square (RMS) currents of the hip motors during the swing phase were included for the trials with an injured user. Using measurements from more gait features during estimation may be provide more information about the user's desired gait speed and be a possible solution to improve estimator performance.

The following analysis was conducted using data from walking trials of an uninjured user with the exoskeleton in free mode. The dataset of an uninjured user was chosen to minimize gait variability as users with iSCIs exhibit higher variability \cite{sohn2018variability}. There are two benefits of considering trials in free mode; gait patterns may reflect the coupling of human-robot dynamics and also exhibit low noise as the exoskeleton does not resist the user's motions. This choice of dataset may make the relationship between gait velocity and the indicators of intent more apparent during the analysis. 

Appropriate gait features must be chosen to prevent adding misleading measurements that may prove detrimental to estimator performance. Candidate gait features for this study were torso pitch and roll angles and angular velocities, and step frequency. As intent estimation happens midway through a step at TD, the step frequency was posed as the ``time-to-TD" ($ t_{TD} $) from MS. Upon comparison to forward velocity at MS, the angles and angular velocities of the torso did not show a significant correlation with gait velocity. This lack of correlation was further confirmed as the correlation coefficients of the torso angles were $ \approx $ 0.2 with p-values greater than 0.5 where the null hypothesis was that the quantities were uncorrelated. The lack of correlation may be explained by the lack of exoskeleton resistance to the user's motions. Torso angles and angular velocities may exhibit a correlation with gait speed in adaptive mode \cite{suzuki2007intention}. In contrast, $ t_{TD} $ and step length $ l_{step} $ were found to be highly correlated gait velocity with correlation coefficients greater than 0.7 and p-values less than 0.05. Therefore, $ t_{TD} $ and $ l_{step} $ were chosen for inclusion in the estimator. 

A training dataset was created for these gait features from a set of 3 SU and SD trials each. The dataset contained gait information for four steps after the speed change command was issued to enable training the models using measurements that may contain the most information about gait speed changes without polluting the data with measurements taken during steady-state walking. The regressions were set up such that $ \Psi_{k+1} = f(v_k,z_k) $, where $ \Psi $ was a gait feature to be modeled, the subscript $ x $ has been omitted for conciseness, and the desired velocity was $ z = v_{k+1} $. This formulation provided insight into the selected gait features, using future speed data to provide a proxy for the intended speed.

\subsection{Estimation using linear models}

A baseline was established by running estimator trials using only measurements of step length at TD. The percentage of successful inference of the user's desire to change velocity for every step in the aggregated trials of the uninjured subject was 70\% with a 95\% confidence interval of 60\% - 79\%. Step length was modeled as described in \eqref{eq:stepModel}. A second model $t_{TD} =  [v_x\ (z - v_x)\ 1] \greekvec{\xi}_{lin}$ was used to establish a relationship between velocity and step frequency where $ \greekvec{\xi}_{lin} $ was calculated similarly to the step length model. The RMS regression error for this model was 0.12s. The values of $ \greekvec{\kappa}_{lin} $ and $ \greekvec{\xi}_{lin} $ were $[0.34 ,0.37 ,0.37]^T$ and $ [-0.45 ,-0.48 ,0.64]^T $ respectively. 

The estimator with two measurements was rerun for all trials and consistently had success rates greater than 75\% for SU trials and less than 70\% for SD trials except one, which had a 78\% success rate. The aggregated success rate for all trials increased to  72\% with a 95\% confidence interval~\cite{brown2001interval} of 62\% - 81\% and the aggregate RMS error between the estimated and measured gait speed increased from 0.14 m/s to 0.142 m/s.  These results confirm that including additional measurements at TD may improve the binary estimation accuracy of the estimator. The next step was to explore the effects of increasing model complexity on the RMS error and speed change detection accuracy with two candidate model types, polynomial and GPR.

\subsection{Estimation using polynomial models}

Model complexity was increased to try and establish a more comprehensive relationship between the velocity and gait features. Since experimental data has shown the stride frequency and step length relationship to be proportional to the square of the gait velocity~\cite{bailey2017relationship}, second-degree polynomials were considered to model $ l_{step} $ and $ t_{TD} $ as functions of $ v_x $ and $ z $. The models had a general structure $ \Psi = [1\ a\ b\ a^2\ ab\ b^2 ] \greekvec{\lambda}$ where $ \Psi $ represents the gait feature, $ l_{step} $ or $ t_{TD} $, $ \greekvec{\lambda} $ represents a vector of the regression coefficients $ \greekvec{\kappa}_{poly} $ or $ \greekvec{\xi}_{poly} $, and $ a $ and $ b $ represent $v_x$ and $(z - v_x) $ respectively. Compared to the linear model with one measurement, the aggregated success rate for all trials decreased to  64\% from 70\% with a 95\% confidence interval of 53\% - 75\% while the aggregate RMS error increased from 0.14 m/s to 0.142 m/s.

\subsection{Estimation using Gaussian Process Regression}

The second class of models considered for this project were Gaussian Processes (GPs). A GP is a set of random variables, such that any finite number of them have a joint Gaussian distribution \cite{rasmussen2006gaussian}. Gaussian Process Regression (GPR) for a vector of observations $ \vec{y} $ may be formulated using the input vector $ \vec{x} $ and a GP $ f(\vec{x}) \sim \mathcal{GP}(0,k(\vec{x},\vec{x}_{*})) $ where $ k(\vec{x},\vec{x}_{*}) $ is a covariance, or kernel, function evaluated at a test point $ \vec{x}_{*} $. Furthermore, an optional basis function $ h(\vec{x}) $ with coefficients $ \greekvec{\beta} $ may be added such that
\begin{equation}
	\vec{y} = h(\vec{x})^T \greekvec{\beta} + f(\vec{x})
\end{equation}
This addition implies the data is close to the basis function and the residuals can be modeled by the GP making GPRs probabilistic and nonparametric as $ f(\vec{x}) $ outputs a vector of latent variables that scales with $ \vec{x} $.

Regression was performed on measurements to fit the GP models for $ l_{step} $ and $ t_{TD} $ using the \texttt{fitrgp} function in  MATLAB. This function uses Bayesian optimization to select values of $ \greekvec{\beta} $, the kernel, and associated hyperparameters. Hyperparameters are the free parameters in a kernel such as signal standard deviation $ \sigma_f $ and length-scale $ \sigma_l $ or $ \sigma_m $ if length-scales are different. Length-scale is a measure of the distance between two input values that may cause response values to become uncorrelated. Too small a length-scale may result in overfitting and a large length-scale may result in a poor fit. The GPR model for $ l_{step} $ was a function of $ v_k $, $ z $ and $ l_{leg} $; the Rational Quadratic kernel as listed in Table~\ref{table:kernel} was chosen for this model where the hyperparameter $ \alpha $ is a scale-mixture parameter. The hyperparameter values for $ \sigma_f $, $ \sigma_l $, and $ \alpha $ were 0.04, 0.08, and 4.19$ \times $10\textsuperscript{4} respectively. The GPR model for $ t_{TD} $ was a function of $ v_k $ and $ z $; the Squared Exponential kernel  was chosen with different length-scales for each input. The hyperparameter values for $ \sigma_f $, $ \sigma_1 $, and $ \sigma_2 $ were 0.44, 5.97, and 16.15 respectively. A quadratic basis function was chosen for the GPR model for $ l_{step} $ by the hyperparameter optimization and no basis function was chosen for the GPR model for $ t_{TD} $.

\begin{table}
	\centering
	\caption{Kernels used in GPR models}\label{table:kernel}
	\begin{tabular}{|c|c|}
		\hline
		Rational Quadratic & ARD Squared Exponential \\
		\hline
		{$\begin{aligned}
				k(x,x_*) &= \sigma_f^2 \left( 1 + \frac{r^2}{2 \alpha \sigma_l^2}\right)^{-\alpha}\\
				r &= \sqrt{(x-x_*)^T(x-x_*)}
			\end{aligned}$} & $ k(x,x_*) = \sigma_f^2 exp\left[\frac{-1}{2} \sum_{m = 1}^{2} \frac{(x_m - x_{*m})^2}{\sigma_m^2} \right] $ \\
		\hline
	\end{tabular}
\end{table}

As listed in \eqref{eq:tdUp} and \eqref{eq:tdCovUp}, the BKF framework needs a Jacobian of the measurement models to perform the Bayesian update at TD. It is possible to compute the Jacobians analytically for the GPR models, however, they were computed numerically to allow changing models and test different kernel functions without significant overhead. As GPR models are probabilistic, the uncertainty of their predictions is was computed and incorporated into the estimator. This inclusion was able to improve the estimation accuracy for the trials and similar updates may not be performed with other model families due to the absence of a kernel function. Over all the SU and SD trials, this configuration had a success rate of 70\% with a confidence interval of 59\% to 79\% with an RMS estimation error of 0.12 m/s. This RMS error was the lowest of all the configurations. This configuration had an accuracy of 79\% for SD trials and 61\% for SU trials.

Increasing the number of gait features considered resulted in a clear improvement in estimator performance. In contrast, increasing  model complexity did not yield significant improvements in estimator accuracy, but resulted in an increased number of parameters that require tuning. This tuning problem will get increasingly challenging as more gait features are considered. Therefore, the estimator models were chosen to be kept simple while increasing the number of gait features used in the estimator.

\section{Summary}

This chapter shows that the intent detection framework based on a Buttressed Kalman Filter is capable of predicting intent changes in exoskeleton users with and without iSCIs based on foot placement and leg swing currents. It can be inferred that the hip currents may be a better indicator of intent in individuals with iSCIs as their actions to modify their foot placement may not be completed due to the resistance from the exoskeleton. So we can argue that attempted foot placement is the primary mechanism of exhibiting intent change in individuals with iSCIs, but the human-robot interface causes this information to show up on hip current rather than kinematic data. This result motivated the consideration of measurements from multiple gait features at TD.

Including additional measurements at TD had a larger contribution toward increasing the estimator's probability of success than increasing the complexity of the measurement models. Neither of these two approaches had a conclusive effect on increasing the metric precision of the estimated desired speed. The estimator had difficulty using gait features to speed changes under 0.15 m/s often leading to false predictions leading to deterioration in estimator accuracy. Thresholds based on a user's gait variability may be incorporated to reject these false predictions. As evidenced by the use of different gait features for the injured and uninjured subjects, gait feature relevance may be user-specific which motivates the personalization estimators to maintain estimation accuracy.